# 数仓与结构理论
## 数据仓库分层
+ ODS（原始数据层）--原始数据
+ DWD（明细数据层）--清洗后数据
+ DWS（数据服务层）--轻度汇总（按天）
+ DWT（数据主题层）--主题汇总
+ ADS（数据应用层）--为应用提供数据支持
### 分层原因
+ 简化复杂问题（分解任务，降低耦合）
+ 减少重复开发（每一层落盘）
+ 隔离原始数据
### 数据集市与数据仓库区别
数据集市是无限数据仓库（按部门划分）
+ 数据仓库--企业级别
+ 数据集市--部门基本
### 命名规则
#### 表
+ ODS层命名为ods_表名
+ DWD层命名为dwd_dim/fact_表名
+ DWS层命名为dws_表名  
+ DWT层命名为dwt_购物车
+ ADS层命名为ads_表名
+ 临时表命名为xxx_tmp
+ 用户行为表，以log为后缀。
#### 脚本
+ 数据源_to_目标_db/log.sh
    ```shell
    HDFS_to_ods_log.sh
    ```
+ 用户行为脚本以log为后缀；业务数据脚本以db为后缀。
## 数仓理论
### 关系建模
+ 完全函数依赖--A,B==>C,A!=>C/B!=>C则称C完全依赖A,B
+ 部分函数依赖--A,B==>C,A==>C/B==>C则称C部分依赖A,B
+ 传递函数依赖--A==>B,B==>C则称C传递依赖A
#### 范式理论
+ 定义：设计一张数据表的表结构，符合的标准级别。 规范和要求
+ 目的：降低数据的冗余性
##### 第一范式：属性不可切割
##### 第二范式：不能存在<font color=red>部分函数依赖</font>
##### 第三范式：不能存在<font color=red>传递函数依赖</font>
### 关系建模与维度建模
##### 联机事务处理（OLTP）--业务系统随机的增删改查（数据量较小）
##### 联机分析处理（OLAP）--数据分析（数据量较大）
#### 对比关系建模与维度建模
|对比属性|OLTP|OLAP|
|---|---|---|
|读特性|每次查询只返回少量记录|对大量记录进行汇总|
|写特性|随机、低延时写入用户的输入|批量导入|
|使用场景|用户，Java EE项目|内部分析师，为决策提供支持|
|数据表征|最新数据状态|随时间变化的历史状态|
|数据规模|GB|TB到PB|
+ 关系建模--> 冗余少，但是在大规模数据，跨表分析统计查询过程中，会造成多表关联，这会大大降低执行效率。
+ 维度建模--> 以某一个事实表为中心进行表的组织，主要面向业务，特征是可能存在数据的冗余，但是能方便的得到数据。
![modole.PNG](https://i.loli.net/2020/05/27/hr6D2n3PSbsUTlL.png)
### 维度建模
#### 维度表和事实表
##### 维度表
+ 对事实的描述信息（每一张维表对应现实世界中的一个对象/概念）
##### 维度特征
+ 维表的范围宽（属性多、列多）
+ 内容固定：编码表
+ 行数较小（<10万）

例：时间维度表
|日期ID|day of week|day of year|季度|节假日|
|---|---|---|---|---|
|2020-1-1|1|1|1|元旦|
|2020-5-1|5|122|2|劳动节|
##### 事实表
+ 事实表中的每行数据代表一个业务事件
+ “事实”这个术语表示的是业务事件的度量值
##### 事实特征
+ 事实表特征很大
+ 内容相对的窄：列数较少
+ 经常发生变化，每天会新增加很多
#### 事务型事实表
+ 以每个事务或事件为单位(一个销售订单记录，一笔支付记录)作为事实表里的一行数据。
+ 一旦事务被提交，事实表数据被插入，数据就不再进行更改，其更新方式为增量更新。  
#### 周期型快照事实表
+ 不会保留所有数据,只保留固定时间间隔的数据。(每天或者每月的销售额，或每月的账户余额等)。
#### 累积型快照事实表
+ 累计快照事实表用于跟踪业务事实的变化。

数据仓库中可能需要累积或者存储订单从下订单开始，到订单商品被打包、运输、和签收的各个业务阶段的时间点数据来跟踪订单声明周期的进展情况（下单-签收时间）
|订单id|用户id|下单时间|打包时间|发货时间|签收时间|订单金额|
|---|---|---|---|---|---|---|
|||5-26|5-27|5-29|2-31|
## <font color=blue>数据仓库建模（绝对重点）</font>
### ODS层
+ 保持数据原貌不做任何修改，起到备份数据的作用。
+ 数据采用压缩(LZO)，减少磁盘存储空间（例如：原始数据100G，可以压缩到10G左右）
+ 创建分区表(按日期分区)，防止后续的全表扫描
### DWD层(事实表为中心)
#### 维度建模四个步骤：
+ 选择业务过程→声明粒度→确认维度→确认事实
##### 选择业务过程
+ 在业务系统中，挑选所需的的业务线(下单业务，支付业务，退款业务，物流业务)
+ 一条业务线对应一张事实表。
##### 声明粒度
+ 数据<font color=red>粒度</font>指数据仓库的表中保存数据的<font color=red>细化程度</font>或<font color=red>综合程度</font>的<font color=red>级别</font>。
+ 声明粒度意味着精确定义事实表中的一行数据表示什么，应该<font color=red>尽可能选择最小粒度</font>，以此来应各种各样的需求。
+ 典型的粒度声明：
1. 订单中，每个商品项作为下单事实表中的一行，粒度为商品项
2. 每周的订单次数作为一行，粒度就是每周下单。 
3. 每月的订单次数作为一行，粒度就是每月下单
##### 确定维度
+ 维度的主要作用是描述业务是事实，主要表示的是“<font color=red>谁，何处，何时</font>”等信息。
+ 确定每一张事实表和哪些维度表有关（所有 与事实表有关的维度表）
##### 确定事实
+ 此处的“事实”一词，指的是业务中的<font color=red>度量值</font>（订单金额、下单次数等）
+ 在DWD层，以业务过程为建模驱动，基于每个具体业务过程的特点，构建<font color=red>最细粒度</font>的明细层事实表
+ 事实表可做适当的宽表化处理。

业务总线矩阵：
|事物(粒度)\维度|时间|用户|地区|商品|优惠券|活动|编码|度量值（事实表）|
|---|---|---|---|---|---|---|---|---|
|订单|√|√|√|||√||件数/金额|
|订单详情|√||√|√||||件数/金额|
|支付|√||√|||||金额|
|加购|√|√||√||||件数/金额|
|收藏|√|√||√||||次数|
|评价|√|√||√||||次数|
|退款|√|√||√||||件数/金额|
|优惠券领用|√|√|||√|||个数|
维度图（将与某一维度相关的所有表汇总到一个表里）
![1.PNG](https://i.loli.net/2020/05/29/5RGAzslDnp8tHO3.png)
 DWD层需构建维度模型，一般采用星型模型，呈现的状态一般为星座模型。

DWS、DWT和ADS和维度建模没有关系

DWS和DWT都是建宽表，宽表都是按照主题去建。主题相当于观察问题的角度。对应着维度表。
###  DWS层(维度表为中心)
+ 统计各个<font color=red>主题对象</font>的<font color=red>当天行为</font>，服务于DWT层的主题宽表。
### DWT层
+ 分析的<font color=red>主题对象</font>,基于上层的应用和产品的指标需求，构建主题对象的<font color=red>全量宽表</font>。
### ADS层
+ 对电商系统各大主题指标分别进行分析