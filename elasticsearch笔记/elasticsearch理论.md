# elasticsearch理论部分
ElasticSearch是一个Java开发的<font color=red>基于Lucene的搜索服务器</font>。它提供了一个分布式多用户能力的<font color=red>全文搜索</font>引擎，基于RESTful web接口。

>elasticSearch的使用场景
1. 为用户提供按关键字查询的全文搜索功能。
2. 实现企业海量数据的处理分析的解决方案。大数据领域的重要一份子，如著名的ELK框架(ElasticSearch,Logstash,Kibana)。

数据存储比较

|	|redis|mysql|elasticsearch|hbase|hadoop/hive|
|---|---|---|---|---|---|
|容量/容量扩展|低|中|较大|海量|海量|
|查询时效性|极高|中等|较高|中等|低|
|查询灵活性|较差 k-v模式|非常好，支持sql|较好，关联查询较弱，但是可以全文检索，DSL语言可以处理过滤、匹配、排序、聚合等各种操作|较差，主要靠rowkey,scan的话性能不行，或者建立二级索引|非常好，支持sql|
|写入速度|极快|中等|较快|较快|慢|
|一致性、事务|弱|强|弱|弱|弱|

从常用数据库比较可以看出ES在数据库中拥有检索所读快的优点,并无明显短板

## elasticsearch的特点
+ 天然分片，天然集群

es 把数据分成多个shard，下图中的P0-P2，多个shard可以组成一份完整的数据，这些shard可以分布在集群中的各个机器节点中。随着数据的不断增加，集群可以增加多个分片，把多个分片放到多个机子上，已达到负载均衡，横向扩展。
![1.png](https://i.loli.net/2020/06/15/BmThiuDFeE9X3O1.png)
在实际运算过程中，每个查询任务提交到某一个节点，该节点必须负责将数据进行整理汇聚，再返回给客户端，也就是一个简单的节点上进行Map计算，在一个固定的节点上进行Reduces得到最终结果向客户端返回。
![2.png](https://i.loli.net/2020/06/15/ZUwvWNnYzVgFKqf.png)
+ 天然索引 
ES 所有数据都是默认进行索引的，这点和mysql正好相反，mysql是默认不加索引，要加索引必须特别说明，ES只有不加索引才需要说明。
而ES使用的是<font color=red>倒排索引</font>和Mysql的B+Tree索引不同(只能逐字逐行的匹配，性能非常差)。

+ 倒排索引的处理 (内容/分词-->主键)
1. 全文搜索引擎目前主流的索引技术是倒排索引的方式。

|传统的保存数据的方式|倒排索引的保存数据的方式|
|---|---|
|记录→单词|单词→记录|

2. 传统数据库保存数据：

|id|标题|
|---|---|
|1|红海行动影评|
|2|红海事件始末|
|3|电影导演|

3. 倒排索引保存的数据见表（分词技术构建倒排索引）：
首先每个记录保存数据时，都不会直接存入数据库。系统先会对数据进行分词，然后以倒排索引结构保存。

|分词|ids|
|---|---|
|红海|1，2|
|行动|1，3|
|影评|1|
|事件|2|
|始末|2|
|电影|3|
|导演|3|

用户搜索的时候，会把搜索的关键词也进行分词，会把<font color=red>“红海行动”</font>分词分成：<font color=red>红海</font>和<font color=red>行动</font>两个词。

先用红海进行匹配，得到id=1和id=2的记录编号，再用行动匹配可以迅速定位id为1,3的记录。

那么全文索引通常，还会根据匹配程度进行打分，显然1号记录能匹配的次数更多。所以显示的时候以评分进行排序的话，1号记录会排到最前面。而2、3号记录也可以匹配到按照排序显示。
>索引结构对比

B+Tree

![3.png](https://i.loli.net/2020/06/15/1o6ht7fgBe2wkHW.png)

lucene 倒排索引结构

![4.png](https://i.loli.net/2020/06/15/2Jpvt4BQgyZ8Hs1.png)

 lucene  为倒排索引(Term Dictionary)部分又增加一层Term Index结构，用于快速定位，而这Term Index是缓存在内存中的，但mysql的B+tree不在内存中，所以整体来看ES速度更快，但同时也更消耗资源（内存、磁盘）。

 ### lucene与elasticsearch的关系
 + lucene是一个提供全文搜索功能类库的核心工具包，真正使用需要一个完善的服务框架搭建起来的应用。
+ 好比lucene是类似于发动机，而搜索引擎软件（ES,Solr）就是汽车。
+ 目前市面上流行的搜索引擎软件，主流的就两款，elasticsearch和solr,这两款都是基于lucene的搭建的，可以独立部署启动的搜索引擎服务软件。

